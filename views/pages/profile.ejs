<!DOCTYPE html> <!-- checkpoint -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | CodeMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%233B82F6' d='M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5'></path></svg>">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .nav-link {
            padding: 0.25rem 0.5rem;
            color: #4b5563;
            transition: color 0.2s, border-color 0.2s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .nav-link:hover {
            color: #1f2937;
            border-bottom-color: #6366f1;
        }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
    </style>
    <script src="/js/darkmode.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="/css/darkmode-improved.css">
</head>
<body class="bg-gray-50 dark:bg-gray-700 transition-colors duration-300 dark:bg-gray-900">
    <%- include('../partials/header') %>
    <div class="min-h-screen flex flex-col">
        <main class="flex-grow py-8">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">My Profile</h1>
                    <div class="flex gap-3">
                        <button id="edit-profile-button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">Edit Profile</button>
                        <button id="delete-account-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden">Delete Account</button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 mb-6">
                    <div class="flex flex-col md:flex-row items-center">
                        <div class="md:w-1/4 flex justify-center mb-4 md:mb-0">
                            <div id="main-avatar" class="h-32 w-32 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 text-5xl font-bold">HP</div>
                        </div>
                        <div class="md:w-3/4 md:pl-8">
                            <h2 id="profile-name" class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-1">Loading...</h2>
                            <p id="profile-role" class="text-gray-600 dark:text-gray-400 mb-4">Loading Role...</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Email</p>
                                    <p id="profile-email">N/A</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Location</p>
                                    <p id="profile-location">Ho Chi Minh City, Vietnam</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order History Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6">Order History</h2>

                    <div id="order-history-loading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">Loading orders...</p>
                    </div>

                    <div id="order-history-empty" class="hidden text-center py-12">
                        <i class="fas fa-shopping-bag text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-400 text-lg">No orders yet</p>
                        <p class="text-gray-500 dark:text-gray-500 text-sm mt-2">Your purchase history will appear here</p>
                    </div>

                    <div id="order-history-list" class="hidden space-y-4">
                        <!-- Orders will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

<div id="profile-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-30">
    <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 m-4 max-w-md w-full">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">Edit Your Profile</h2>
        <form id="edit-profile-form" class="space-y-4">
            <input type="hidden" id="edit-user-id">
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Profile Picture</label>
                <div class="flex items-center space-x-4">
                    <div id="edit-avatar-display" class="h-20 w-20 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 text-2xl font-bold flex-shrink-0">HP</div>
                    <div class="flex-grow">
                        <div id="avatar-drop-zone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-indigo-500 transition-colors">
                            <input type="file" id="avatar-file-input" accept="image/*" class="hidden">
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                <span class="text-indigo-600 dark:text-indigo-400 font-semibold">Click to upload</span> or drag and drop
                            </p>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 5MB</p>
                        </div>
                        <div id="upload-progress" class="hidden mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="upload-progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="upload-status" class="text-xs text-gray-600 dark:text-gray-400 mt-1">Uploading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="edit-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                <input type="text" id="edit-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="edit-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email (Cannot be changed)</label>
                <input type="email" id="edit-email" disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-100 dark:bg-gray-700 cursor-not-allowed">
            </div>

            <div class="mt-6 flex justify-end space-x-3 pt-4">
                <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold">Save Changes</button>
            </div>
        </form>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- AUTH, USER INFO, & GLOBAL VARS ---
    let user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    
    if (!token || !user) {
        window.location.href = '/login';
        return;
    }

    // --- ELEMENTS ---
    const profileModal = document.getElementById('profile-modal');
    const editForm = document.getElementById('edit-profile-form');
    const avatarDropZone = document.getElementById('avatar-drop-zone');
    const avatarFileInput = document.getElementById('avatar-file-input');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const uploadStatus = document.getElementById('upload-status');

    // Store the uploaded avatar URL
    let uploadedAvatarUrl = null;

    function getUserInitials(name) {
        if (!name) return '??';
        const parts = name.split(' ');
        let initials = parts[0].charAt(0).toUpperCase();
        if (parts.length > 1) {
            initials += parts[parts.length - 1].charAt(0).toUpperCase();
        }
        return initials;
    }

    function renderProfile(userData) {
        const initials = getUserInitials(userData.name);
        const avatarContainer = document.getElementById('main-avatar');

        // Cập nhật Header Avatar with profile picture
        const headerAvatar = document.getElementById('user-avatar');
        if (headerAvatar) {
            if (userData.avatarUrl) {
                headerAvatar.innerHTML = `<img src="${userData.avatarUrl}" alt="Avatar" class="h-8 w-8 rounded-full object-cover">`;
            } else {
                headerAvatar.textContent = initials;
                headerAvatar.className = 'h-8 w-8 rounded-full bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center text-white font-semibold';
            }
        }

        // Xử lý Main Profile Avatar
        const avatarImg = userData.avatarUrl || null;
        if (avatarImg) {
            avatarContainer.innerHTML = `<img src="${avatarImg}" alt="Avatar" class="h-32 w-32 rounded-full object-cover">`;
        } else {
             avatarContainer.innerHTML = initials;
             avatarContainer.className = 'h-32 w-32 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 text-5xl font-bold';
        }

        // Cập nhật các trường thông tin
        document.getElementById('profile-name').textContent = userData.name || 'Student';
        document.getElementById('profile-role').textContent = (userData.role || 'student').charAt(0).toUpperCase() + (userData.role || 'student').slice(1);
        document.getElementById('profile-email').textContent = userData.email || 'N/A';

        // Cập nhật localStorage
        localStorage.setItem('user', JSON.stringify(userData));
        user = userData; // Cập nhật biến global
    }

    function openEditModal() {
        // Điền dữ liệu hiện tại vào form
        document.getElementById('edit-user-id').value = user.id;
        document.getElementById('edit-name').value = user.name || '';
        document.getElementById('edit-email').value = user.email || '';

        // Reset uploaded avatar URL
        uploadedAvatarUrl = user.avatarUrl || null;

        // Cập nhật preview avatar trong modal
        const display = document.getElementById('edit-avatar-display');
        if (user.avatarUrl) {
             display.innerHTML = `<img src="${user.avatarUrl}" alt="Avatar" class="h-20 w-20 rounded-full object-cover">`;
        } else {
             display.innerHTML = getUserInitials(user.name);
             display.className = 'h-20 w-20 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 text-2xl font-bold flex-shrink-0';
        }

        profileModal.classList.remove('hidden');
    }

    function closeEditModal() {
        profileModal.classList.add('hidden');
    }

    // --- Drag and Drop Functionality ---

    // Handle file upload
    async function uploadProfilePicture(file) {
        if (!file || !file.type.startsWith('image/')) {
            alert('Please select a valid image file');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // Show progress
        uploadProgress.classList.remove('hidden');
        uploadProgressBar.style.width = '0%';
        uploadStatus.textContent = 'Uploading...';

        try {
            const response = await fetch('/api/upload/profile-picture', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Upload failed');
            }

            const data = await response.json();

            // Update progress
            uploadProgressBar.style.width = '100%';
            uploadStatus.textContent = 'Upload complete!';

            // Store the uploaded URL
            uploadedAvatarUrl = data.url;

            // Update preview
            const display = document.getElementById('edit-avatar-display');
            display.innerHTML = `<img src="${data.url}" alt="Avatar" class="h-20 w-20 rounded-full object-cover">`;

            // Hide progress after a delay
            setTimeout(() => {
                uploadProgress.classList.add('hidden');
            }, 2000);

            // Update local user data
            user.avatarUrl = data.url;
            localStorage.setItem('user', JSON.stringify(user));
            renderProfile(user);

        } catch (error) {
            console.error('Upload error:', error);
            uploadStatus.textContent = 'Upload failed. Please try again.';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.classList.add('bg-red-600');

            setTimeout(() => {
                uploadProgress.classList.add('hidden');
                uploadProgressBar.classList.remove('bg-red-600');
            }, 3000);
        }
    }

    // Click to upload
    avatarDropZone.addEventListener('click', () => {
        avatarFileInput.click();
    });

    avatarFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            uploadProfilePicture(file);
        }
    });

    // Drag and drop events
    avatarDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        avatarDropZone.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900');
    });

    avatarDropZone.addEventListener('dragleave', () => {
        avatarDropZone.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900');
    });

    avatarDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        avatarDropZone.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900');

        const file = e.dataTransfer.files[0];
        if (file) {
            uploadProfilePicture(file);
        }
    });

    // --- EVENT LISTENERS ---
    document.getElementById('edit-profile-button').addEventListener('click', openEditModal);
    document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);

    // 3. Xử lý Submit Form
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = editForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        const updatedData = {
            name: document.getElementById('edit-name').value.trim(),
            // Lấy phone nếu có, nếu không thì gửi null/chuỗi rỗng, API sẽ xử lý
            phone: document.getElementById('edit-phone').value.trim() || null
            // Note: avatarUrl is updated via uploadProfilePicture function
        };

        const userId = user.id;

        try {
            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(updatedData)
            });

            if (!response.ok) {
                let errorMsg = "Failed to save profile changes.";
                try {
                    const errorJson = await response.json();
                    errorMsg = errorJson.error || errorJson.message || errorMsg;
                } catch {
                    errorMsg = await response.text();
                }
                throw new Error(errorMsg);
            }
            
            // Lấy profile mới, nhưng thường API PUT sẽ trả về dữ liệu gửi đi
            // Nên ta tự cập nhật profile cục bộ
            const newUserProfile = { ...user, ...updatedData };

            renderProfile(newUserProfile); // Cập nhật UI và localStorage
            closeEditModal();
            alert('Profile updated successfully! 🎉');

        } catch (error) {
            console.error("Profile Update Error:", error);
            alert('Error updating profile: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Changes';
        }
    });
    
    // 4. Logout (Giữ nguyên)
    document.getElementById('logout-button').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = '/login';
    });

    // --- ORDER HISTORY ---
    async function loadOrderHistory() {
        const loadingEl = document.getElementById('order-history-loading');
        const emptyEl = document.getElementById('order-history-empty');
        const listEl = document.getElementById('order-history-list');

        try {
            const response = await fetch(`/api/orders?userId=${user.id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to load orders');

            const allOrders = await response.json();

            // Filter orders by current user
            const userOrders = allOrders.filter(order => order.userId === user.id);

            loadingEl.classList.add('hidden');

            if (userOrders.length === 0) {
                emptyEl.classList.remove('hidden');
                return;
            }

            // Sort by date (newest first)
            userOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            listEl.classList.remove('hidden');
            listEl.innerHTML = userOrders.map(order => {
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
                    'completed': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
                    'cancelled': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',
                    'refunded': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300'
                };

                const statusColor = statusColors[order.status] || 'bg-gray-100 text-gray-800';
                const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const courseName = order.course?.title || order.courseName || 'Unknown Course';

                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-shopping-cart text-indigo-600 dark:text-indigo-400 text-xl"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 text-lg">${courseName}</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                            Order ID: <span class="font-mono">${order.id.substring(0, 12)}...</span>
                                        </p>
                                        <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">
                                            <i class="fas fa-calendar-alt mr-1"></i>${orderDate}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <span class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
                                    $${parseFloat(order.price || 0).toFixed(2)}
                                </span>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">
                                    ${order.status.toUpperCase()}
                                </span>
                                ${order.paymentMethod ? `
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-credit-card mr-1"></i>${order.paymentMethod}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading order history:', error);
            loadingEl.classList.add('hidden');
            listEl.classList.remove('hidden');
            listEl.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p>Error loading order history</p>
                    <p class="text-sm mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    // --- DELETE ACCOUNT FUNCTIONALITY ---
    const deleteAccountButton = document.getElementById('delete-account-button');
    
    // Show delete button only for students
    if (user && user.role && user.role.toLowerCase() === 'student') {
        deleteAccountButton.classList.remove('hidden');
    }

    deleteAccountButton.addEventListener('click', async function() {
        const confirmation = confirm('⚠️ WARNING: This will permanently delete your account and all associated data.\n\nAre you absolutely sure you want to delete your account? This action CANNOT be undone.');
        
        if (!confirmation) return;
        
        // Double confirmation
        const doubleCheck = prompt('To confirm, please type "DELETE" (all capitals):');
        if (doubleCheck !== 'DELETE') {
            alert('Account deletion cancelled.');
            return;
        }

        try {
            const response = await fetch(`/api/users/${user.id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to delete account');
            }

            alert('Your account has been successfully deleted.');
            
            // Clear localStorage and redirect to home
            localStorage.clear();
            window.location.href = '/';
            
        } catch (error) {
            console.error('Error deleting account:', error);
            alert(`Failed to delete account: ${error.message}`);
        }
    });

    // --- INITIALIZATION ---
    renderProfile(user); // Khởi tạo giao diện với dữ liệu hiện tại
    loadOrderHistory(); // Load order history
});
</script>