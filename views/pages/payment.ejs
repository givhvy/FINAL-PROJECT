<!DOCTYPE html> <!-- checkpoint -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade Plan | UniLearn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .plan-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        .badge {
            position: absolute;
            top: -10px;
            right: 20px;
        }
        .nav-link {
            padding: 0.25rem 0.5rem;
            color: #4b5563;
            transition: color 0.2s, border-color 0.2s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .nav-link:hover {
            color: #1f2937;
            border-bottom-color: #3b82f6;
        }
        .nav-link.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .faq-icon.rotate-180 {
             transform: rotate(180deg);
        }
    </style>
    <script src="/js/darkmode.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="/css/darkmode-improved.css">
</head>
<body class="transition-colors duration-300 bg-gray-50 dark:bg-gray-900">
    <%- include('../partials/header') %>
    <div class="min-h-screen flex flex-col">
        <!-- Header đồng bộ -->
        <!-- Main Content -->
        <main class="container mx-auto px-4 py-12 flex-grow">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold text-gray-800 dark:text-gray-200 mb-4">Choose Your Learning Journey</h2>
                <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">Unlock your potential with our flexible subscription plans designed to fit your learning style and goals.</p>
            </div>

            <!-- Student Verification Section -->
            <div class="max-w-2xl mx-auto mb-12">
                <div class="bg-gradient-to-r from-blue-50 to-blue-50 dark:from-gray-800 dark:to-gray-700 border-2 border-blue-200 dark:border-gray-600 rounded-2xl p-8 shadow-lg">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Student Discount - 100% FREE!</h3>
                        <p class="text-gray-600 dark:text-gray-300">Are you a student? Verify your educational email to get full access for free!</p>
                    </div>

                    <form id="student-verification-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Educational Email Address</label>
                            <div class="relative">
                                <input type="email" id="student-email" required
                                    placeholder="your.name@university.edu"
                                    class="w-full px-4 py-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400 dark:placeholder-gray-500">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <i class="fas fa-envelope text-gray-400"></i>
                                </div>
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Must be a valid .edu or .ac email address</p>
                        </div>

                        <button type="submit" id="verify-student-btn"
                            class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            Verify Student Status
                        </button>
                    </form>

                    <div id="verification-result" class="mt-4 hidden"></div>
                </div>
            </div>


            <!-- Subscription Plans -->
            <div id="plans-container" class="w-full px-4">
                <!-- Pro Plan with Toggle will be loaded here by JavaScript -->
                <div class="text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading subscription plan...</p>
                </div>
            </div>
            
            <!-- FAQ Section -->
            <div class="mt-20 max-w-3xl mx-auto">
                <!-- FAQ content giữ nguyên -->
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));
            if (!token || !user) {
                window.location.href = '/login';
                return;
            }

            // --- UI ELEMENTS ---
            const plansContainer = document.getElementById('plans-container');
            const studentForm = document.getElementById('student-verification-form');
            const studentEmailInput = document.getElementById('student-email');
            const verificationResult = document.getElementById('verification-result');
            let allPlans = [];

            // --- FUNCTIONS ---
            function getUserInitials(user) {
                if (user && user.name) {
                    const parts = user.name.split(' ');
                    let initials = parts[0].charAt(0).toUpperCase();
                    if (parts.length > 1) initials += parts[parts.length - 1].charAt(0).toUpperCase();
                    return initials;
                }
                return 'GS';
            }

            // Kiểm tra email education (kết thúc bằng .edu hoặc .ac)
            function isEducationalEmail(email) {
                const emailPattern = /^[^\s@]+@[^\s@]+\.(edu|ac\.[a-z]{2}|edu\.[a-z]{2})$/i;
                return emailPattern.test(email);
            }

            // Xử lý student verification
            async function handleStudentVerification(e) {
                e.preventDefault();
                const email = studentEmailInput.value.trim();
                const verifyBtn = document.getElementById('verify-student-btn');

                // Validate educational email
                if (!isEducationalEmail(email)) {
                    verificationResult.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                    verificationResult.innerHTML = `
                        <div class="flex items-center text-red-700">
                            <i class="fas fa-times-circle mr-2"></i>
                            <span>Invalid educational email. Please use a valid .edu or .ac email address.</span>
                        </div>
                    `;
                    verificationResult.classList.remove('hidden');
                    return;
                }

                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';

                try {
                    const response = await fetch('/api/users/verify-student', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            user_id: user.id,
                            email: email
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        verificationResult.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-lg';
                        verificationResult.innerHTML = `
                            <div class="flex items-center text-green-700 mb-2">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span class="font-semibold">Verification Successful!</span>
                            </div>
                            <p class="text-green-600 text-sm">Your student status has been verified. You now have FREE access to all courses and features!</p>
                            <button onclick="window.location.href='/courses'" class="mt-3 w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                Start Learning Now
                            </button>
                        `;
                        verificationResult.classList.remove('hidden');

                        // Update user in localStorage with Pro tier
                        user.isStudent = true;
                        user.studentEmail = email;
                        user.subscriptionTier = 'pro';
                        localStorage.setItem('user', JSON.stringify(user));

                        // Update subscription badge in header immediately
                        const tierBadge = document.getElementById('user-tier-badge');
                        if (tierBadge) {
                            tierBadge.innerHTML = `
                                <span class="px-3 py-1 text-xs font-bold bg-gradient-to-r from-yellow-400 via-amber-500 to-yellow-600 text-white rounded-full flex items-center gap-1 shadow-lg">
                                    <i class="fas fa-crown"></i> PRO
                                </span>
                            `;
                        }

                        // Hide plans section after 2 seconds
                        setTimeout(() => {
                            document.getElementById('plans-container').style.display = 'none';
                        }, 2000);

                    } else {
                        verificationResult.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                        verificationResult.innerHTML = `
                            <div class="flex items-center text-red-700">
                                <i class="fas fa-times-circle mr-2"></i>
                                <span>${data.error || 'Verification failed. Please try again.'}</span>
                            </div>
                        `;
                        verificationResult.classList.remove('hidden');
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verify Student Status';
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    verificationResult.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                    verificationResult.innerHTML = `
                        <div class="flex items-center text-red-700">
                            <i class="fas fa-times-circle mr-2"></i>
                            <span>An error occurred. Please try again later.</span>
                        </div>
                    `;
                    verificationResult.classList.remove('hidden');
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verify Student Status';
                }
            }

            // Billing toggle state
            let selectedBilling = 'monthly'; // 'monthly' or 'yearly'
            let plans = []; // All plans from admin
            let proPlan = null; // First paid plan for savings calculation

            // Fetch all subscription plans from admin
            async function fetchSubscriptionPlan() {
                try {
                    const response = await fetch('/api/subscriptions?active=true', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch plans');
                    plans = await response.json();

                    // Get the first paid plan for savings calculation in toggle
                    proPlan = plans.find(p => (p.monthlyPrice || p.monthly_price || 0) > 0) || plans[0];
                    return plans;
                } catch (error) {
                    console.error('Error fetching subscription plans:', error);
                    plans = [];
                    return [];
                }
            }

            function calculateSavings(monthlyPrice, annualPrice) {
                const yearlyIfMonthly = monthlyPrice * 12;
                const savings = yearlyIfMonthly - annualPrice;
                const savingsPercent = Math.round((savings / yearlyIfMonthly) * 100);
                return { savings, savingsPercent };
            }

            function renderPlans() {
                if (!plans || plans.length === 0) {
                    plansContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-circle text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">No subscription plans available.</p>
                            <p class="text-sm text-gray-400 mt-2">Please contact admin to set up subscription plans.</p>
                        </div>
                    `;
                    return;
                }

                const monthlyPrice = proPlan.monthlyPrice || proPlan.monthly_price || 0;
                const annualPrice = proPlan.annualPrice || proPlan.annual_price || 0;
                const features = proPlan.features || [];
                const { savings, savingsPercent } = calculateSavings(monthlyPrice, annualPrice);
                const monthlyFromAnnual = (annualPrice / 12).toFixed(2);

                const currentPrice = selectedBilling === 'monthly' ? monthlyPrice : annualPrice;
                const billingPeriod = selectedBilling === 'monthly' ? '/month' : '/year';
                const planId = selectedBilling === 'monthly' ? 'pro_monthly' : 'pro_yearly';
                const planName = selectedBilling === 'monthly' ? `${proPlan.name} - Monthly` : `${proPlan.name} - Yearly`;

                // Render all plans from admin (supports multiple plans like Free, Pro, etc.)
                const allPlansHTML = plans.map(plan => {
                    const planMonthlyPrice = plan.monthlyPrice || plan.monthly_price || 0;
                    const planAnnualPrice = plan.annualPrice || plan.annual_price || 0;
                    const planFeatures = plan.features || [];
                    const isFree = planMonthlyPrice === 0 && planAnnualPrice === 0;
                    const { savings: planSavings, savingsPercent: planSavingsPercent } = calculateSavings(planMonthlyPrice, planAnnualPrice);
                    const planMonthlyFromAnnual = (planAnnualPrice / 12).toFixed(2);

                    const displayPrice = selectedBilling === 'monthly' ? planMonthlyPrice : planAnnualPrice;
                    const displayPeriod = selectedBilling === 'monthly' ? '/month' : '/year';
                    const displayPlanId = selectedBilling === 'monthly' ? `${plan.id}_monthly` : `${plan.id}_yearly`;
                    const displayPlanName = selectedBilling === 'monthly' ? `${plan.name} - Monthly` : `${plan.name} - Yearly`;

                    if (isFree) {
                        // Free plan card (no toggle effect, always $0)
                        return `
                            <div class="plan-card bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden relative h-full">
                                <div class="p-8">
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">${plan.name}</h3>
                                    <div class="flex items-end mb-6">
                                        <span class="text-4xl font-bold text-gray-800 dark:text-gray-200">$0</span>
                                        <span class="text-gray-500 ml-2 text-base">/month</span>
                                    </div>
                                    <ul class="space-y-3 mb-8 text-gray-600 dark:text-gray-400">
                                        ${planFeatures.length > 0 ? planFeatures.map(feature => `
                                            <li class="flex items-center text-sm">
                                                <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                                ${feature}
                                            </li>
                                        `).join('') : ''}
                                    </ul>
                                </div>
                                <div class="px-8 pb-8">
                                    <button disabled class="w-full py-3 px-4 bg-gray-200 text-gray-600 font-medium text-base rounded-xl cursor-not-allowed">
                                        Current Plan
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // Paid plan card (responds to toggle)
                        return `
                            <div class="plan-card bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden border-2 border-blue-500 relative h-full">
                                ${selectedBilling === 'yearly' && planSavingsPercent > 0 ? `<div class="badge bg-green-500 text-white px-3 py-1 rounded-full font-medium text-xs">Save $${planSavings.toFixed(0)}</div>` : ''}
                                <div class="p-8">
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">${plan.name}</h3>

                                    <div class="flex items-end mb-2">
                                        <span class="text-4xl font-bold text-blue-600">$${displayPrice.toFixed(2)}</span>
                                        <span class="text-gray-500 ml-2 text-base">${displayPeriod}</span>
                                    </div>

                                    ${selectedBilling === 'yearly' ? `<p class="text-sm text-green-600 dark:text-green-400 font-medium mb-6">$${planMonthlyFromAnnual}/month when billed annually</p>` : '<p class="text-sm text-gray-500 mb-6">Billed monthly</p>'}

                                    <ul class="space-y-3 mb-8 text-gray-600 dark:text-gray-400">
                                        ${planFeatures.length > 0 ? planFeatures.map(feature => `
                                            <li class="flex items-center text-sm">
                                                <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                                ${feature}
                                            </li>
                                        `).join('') : `
                                            <li class="flex items-center text-sm"><i class="fas fa-check-circle text-green-500 mr-3"></i>Unlimited courses</li>
                                            <li class="flex items-center text-sm"><i class="fas fa-check-circle text-green-500 mr-3"></i>All learning materials</li>
                                            <li class="flex items-center text-sm"><i class="fas fa-check-circle text-green-500 mr-3"></i>Certificates</li>
                                            <li class="flex items-center text-sm"><i class="fas fa-check-circle text-green-500 mr-3"></i>Premium content</li>
                                            <li class="flex items-center text-sm"><i class="fas fa-check-circle text-green-500 mr-3"></i>Priority support</li>
                                        `}
                                    </ul>
                                </div>
                                <div class="px-8 pb-8">
                                    <button class="select-plan-btn w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium text-base rounded-xl transition-colors" data-plan-id="${displayPlanId}" data-plan-name="${displayPlanName}" data-plan-price="${displayPrice}" data-billing="${selectedBilling === 'monthly' ? 'Monthly' : 'Yearly'}">
                                        Get ${plan.name}
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }).join('');

                // Determine grid columns based on number of plans
                const gridCols = plans.length === 1 ? 'max-w-2xl' : (plans.length === 2 ? 'grid-cols-1 md:grid-cols-2 w-full max-w-6xl' : 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 max-w-7xl');

                plansContainer.innerHTML = `
                    <!-- Billing Toggle -->
                    <div class="flex justify-center mb-8">
                        <div class="bg-gray-100 dark:bg-gray-800 p-1 rounded-full inline-flex">
                            <button id="toggle-monthly" class="billing-toggle px-6 py-2.5 rounded-full text-sm font-medium transition-all ${selectedBilling === 'monthly' ? 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900'}">
                                Monthly
                            </button>
                            <button id="toggle-yearly" class="billing-toggle px-6 py-2.5 rounded-full text-sm font-medium transition-all ${selectedBilling === 'yearly' ? 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900'} flex items-center gap-2">
                                Yearly
                                ${savingsPercent > 0 ? `<span class="bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 text-xs px-2 py-0.5 rounded-full">Save ${savingsPercent}%</span>` : ''}
                            </button>
                        </div>
                    </div>

                    <!-- Plans Grid -->
                    <div class="grid ${gridCols} gap-8 mx-auto">
                        ${allPlansHTML}
                    </div>
                `;

                // Attach toggle event listeners
                document.getElementById('toggle-monthly').addEventListener('click', () => {
                    selectedBilling = 'monthly';
                    renderPlans();
                });
                document.getElementById('toggle-yearly').addEventListener('click', () => {
                    selectedBilling = 'yearly';
                    renderPlans();
                });

                // Attach select plan button listeners (for all paid plans)
                document.querySelectorAll('.select-plan-btn').forEach(btn => {
                    btn.addEventListener('click', handlePlanSelection);
                });
            }

            async function handlePlanSelection(e) {
                const button = e.target.closest('.select-plan-btn');
                if (!button) return;

                const planId = button.dataset.planId;
                const planName = button.dataset.planName;
                const planPrice = parseFloat(button.dataset.planPrice);
                const billing = button.dataset.billing;

                // Save plan to localStorage for potential cart recovery
                const plan = {
                    id: planId,
                    name: planName,
                    price: planPrice.toFixed(2),
                    billing: billing,
                    icon: 'crown',
                    category: 'Subscription'
                };
                localStorage.setItem('selectedPlan', JSON.stringify(plan));

                // Disable button and show loading
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

                try {
                    const userId = user.id;

                    // Save to cart first for recovery
                    let cart = [];
                    const savedCart = localStorage.getItem('cart');
                    if (savedCart) {
                        cart = JSON.parse(savedCart);
                    }

                    // Check if plan already in cart
                    const existsInCart = cart.some(item => item.id === planId);
                    if (!existsInCart) {
                        cart.push(plan);
                        localStorage.setItem('cart', JSON.stringify(cart));
                    }

                    // Create Stripe checkout session
                    const successUrl = `${window.location.origin}/success?session_id={CHECKOUT_SESSION_ID}`;
                    const cancelUrl = `${window.location.origin}/cart`;

                    const response = await fetch('/api/payments/create-checkout-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            courseId: planId,
                            courseName: planName,
                            price: planPrice,
                            userId: userId,
                            successUrl: successUrl,
                            cancelUrl: cancelUrl
                        })
                    });

                    const data = await response.json();

                    if (!response.ok || !data.url) {
                        throw new Error(data.message || 'Failed to initialize payment gateway.');
                    }

                    // Redirect to Stripe Checkout
                    window.location.href = data.url;

                } catch (error) {
                    console.error('Payment Error:', error);
                    alert(`Payment Initialization Failed: ${error.message}`);
                    button.disabled = false;
                    button.innerHTML = `Get ${proPlan?.name || 'Pro'}`;
                }
            }

            // --- EVENT LISTENERS ---
            const userAvatar = document.getElementById('user-avatar');
            if (userAvatar) userAvatar.textContent = getUserInitials(user);
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.clear(); window.location.href = '/login';
            });

            // Student verification form
            studentForm.addEventListener('submit', handleStudentVerification);

            // --- INITIALIZATION ---
            // Fetch subscription plan from admin and then render
            await fetchSubscriptionPlan();
            renderPlans();
        });
    </script>

        <%- include('../partials/footer') %>
</body>
</html>

