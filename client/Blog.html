<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - CodeMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .blog-card { transition: all 0.3s ease; }
        .blog-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .blog-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0; }
        .blog-content p { margin-bottom: 1rem; }
        .blog-content h1, .blog-content h2, .blog-content h3 { margin: 1.5rem 0 1rem 0; font-weight: 600; }
        .blog-content pre { background: #f3f4f6; padding: 1rem; border-radius: 8px; overflow-x: auto; margin: 1rem 0; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center space-x-2">
                        <i class="fas fa-graduation-cap text-2xl text-indigo-600"></i>
                        <span class="font-bold text-xl text-gray-800">CodeMaster</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-gray-600 hover:text-indigo-600 transition-colors">Home</a>
                    <a href="CourseandLesson.html" class="text-gray-600 hover:text-indigo-600 transition-colors">Courses</a>
                    <a href="Community.html" class="text-gray-600 hover:text-indigo-600 transition-colors">Community</a>
                    <a href="Blog.html" class="text-indigo-600 font-medium">Blog</a>
                    <div id="auth-buttons" class="flex items-center space-x-4">
                        <a href="LoginPage.html" class="text-gray-600 hover:text-indigo-600 transition-colors">Login</a>
                        <a href="LoginPage.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Sign Up</a>
                    </div>
                    <div id="user-menu" class="hidden relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 text-gray-600 hover:text-indigo-600">
                            <div id="user-avatar" class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-sm"></div>
                            <span id="user-name" class="hidden md:inline"></span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden">
                            <a href="ProfilePage.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
                            <a href="AccountProfile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Account Settings</a>
                            <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
                        </div>
                    </div>
                </div>
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">CodeMaster Blog</h1>
            <p class="text-xl md:text-2xl text-indigo-100 mb-8">Insights, tutorials, and stories from the world of programming</p>
            <div class="max-w-md mx-auto">
                <div class="relative">
                    <input type="text" id="blog-search-input" placeholder="Search articles..." class="w-full px-4 py-3 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-white">
                    <i class="fas fa-search absolute right-3 top-4 text-gray-500"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Blog Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Filters -->
        <div class="mb-8 flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">Filter by tag:</label>
                <select id="tag-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">All Tags</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">Sort by:</label>
                <select id="sort-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>
        </div>

        <!-- Blog Posts Grid -->
        <div id="blog-posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Loading state -->
            <div class="col-span-full flex justify-center items-center py-16">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i>
                    <p class="text-gray-600">Loading blog posts...</p>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination-container" class="mt-12 flex justify-center">
            <!-- Pagination will be inserted here -->
        </div>
    </main>

    <!-- Blog Post Modal -->
    <div id="blog-post-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800">Blog Post</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="blog-post-content" class="p-6">
                    <!-- Blog post content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let allBlogPosts = [];
        let filteredPosts = [];
        let availableTags = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthStatus();
            await loadBlogPosts();
            await loadTags();
            setupEventListeners();
        });

        // Check authentication status
        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            if (token && user) {
                document.getElementById('auth-buttons').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');

                const userName = user.name || 'User';
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();

                document.getElementById('user-name').textContent = userName;
                document.getElementById('user-avatar').textContent = userInitials;
            }
        }

        // Load blog posts
        async function loadBlogPosts(page = 1, tag = '', search = '', sort = 'newest') {
            try {
                let url = `/api/blog?page=${page}&limit=9`;
                if (tag) url += `&tag=${encodeURIComponent(tag)}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch blog posts');

                const data = await response.json();
                allBlogPosts = data.posts || [];

                // Apply search and sort filters
                filteredPosts = filterAndSortPosts(allBlogPosts, search, sort);

                displayBlogPosts(filteredPosts);
                displayPagination(data.pagination);
            } catch (error) {
                console.error('Error loading blog posts:', error);
                document.getElementById('blog-posts-container').innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <p class="text-gray-600">Failed to load blog posts. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Load available tags
        async function loadTags() {
            try {
                const response = await fetch('/api/blog/tags');
                if (!response.ok) throw new Error('Failed to fetch tags');

                const tags = await response.json();
                availableTags = tags;

                const tagFilter = document.getElementById('tag-filter');
                tagFilter.innerHTML = '<option value="">All Tags</option>';

                tags.forEach(tagData => {
                    const option = document.createElement('option');
                    option.value = tagData.tag;
                    option.textContent = `${tagData.tag} (${tagData.count})`;
                    tagFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }

        // Filter and sort posts
        function filterAndSortPosts(posts, search, sort) {
            let filtered = posts;

            // Apply search filter
            if (search) {
                filtered = filtered.filter(post =>
                    post.title.toLowerCase().includes(search.toLowerCase()) ||
                    (post.excerpt || '').toLowerCase().includes(search.toLowerCase()) ||
                    (post.tags || []).some(tag => tag.toLowerCase().includes(search.toLowerCase()))
                );
            }

            // Apply sort
            switch (sort) {
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.created_at?.toDate() || 0) - new Date(b.created_at?.toDate() || 0));
                    break;
                case 'popular':
                    filtered.sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
                    break;
                case 'newest':
                default:
                    filtered.sort((a, b) => new Date(b.created_at?.toDate() || 0) - new Date(a.created_at?.toDate() || 0));
                    break;
            }

            return filtered;
        }

        // Display blog posts
        function displayBlogPosts(posts) {
            const container = document.getElementById('blog-posts-container');

            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">No blog posts found matching your criteria.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => {
                const publishDate = post.created_at && post.created_at.toDate ? new Date(post.created_at.toDate()).toLocaleDateString() : 'Unknown';
                const readTime = Math.ceil((post.content || '').split(' ').length / 200);

                return `
                    <article class="blog-card bg-white rounded-lg shadow-md overflow-hidden cursor-pointer" onclick="openBlogPost('${post.slug || post.id}')">
                        ${post.featured_image ? `
                            <img src="${post.featured_image}" alt="${post.title}" class="w-full h-48 object-cover">
                        ` : ''}
                        <div class="p-6">
                            <div class="flex items-center text-sm text-gray-500 mb-3">
                                <span>${publishDate}</span>
                                <span class="mx-2">•</span>
                                <span>${readTime} min read</span>
                                <span class="mx-2">•</span>
                                <span>${post.view_count || 0} views</span>
                            </div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-3 line-clamp-2">${post.title}</h2>
                            <p class="text-gray-600 mb-4 line-clamp-3">${post.excerpt || ''}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-sm">
                                        ${(post.author_name || 'A').charAt(0).toUpperCase()}
                                    </div>
                                    <span class="text-sm text-gray-700">${post.author_name || 'Anonymous'}</span>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    ${(post.tags || []).slice(0, 2).map(tag =>
                                        `<span class="px-2 py-1 bg-indigo-100 text-indigo-600 text-xs rounded-full">${tag}</span>`
                                    ).join('')}
                                    ${post.tags && post.tags.length > 2 ? '<span class="text-xs text-gray-500">+' + (post.tags.length - 2) + '</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        // Display pagination
        function displayPagination(pagination) {
            const container = document.getElementById('pagination-container');
            if (!pagination || pagination.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '<div class="flex items-center space-x-2">';

            // Previous button
            if (pagination.has_prev) {
                paginationHTML += `
                    <button onclick="loadBlogPosts(${pagination.current_page - 1})"
                            class="px-3 py-2 bg-white border rounded-lg text-gray-600 hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
            }

            // Page numbers
            for (let i = Math.max(1, pagination.current_page - 2); i <= Math.min(pagination.total_pages, pagination.current_page + 2); i++) {
                const isActive = i === pagination.current_page;
                paginationHTML += `
                    <button onclick="loadBlogPosts(${i})"
                            class="px-3 py-2 border rounded-lg ${isActive ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}">
                        ${i}
                    </button>
                `;
            }

            // Next button
            if (pagination.has_next) {
                paginationHTML += `
                    <button onclick="loadBlogPosts(${pagination.current_page + 1})"
                            class="px-3 py-2 bg-white border rounded-lg text-gray-600 hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            }

            paginationHTML += '</div>';
            container.innerHTML = paginationHTML;
        }

        // Open blog post in modal
        async function openBlogPost(slug) {
            try {
                const response = await fetch(`/api/blog/${slug}`);
                if (!response.ok) throw new Error('Failed to fetch blog post');

                const post = await response.json();

                const publishDate = post.created_at && post.created_at.toDate ? new Date(post.created_at.toDate()).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : 'Unknown';

                document.getElementById('blog-post-content').innerHTML = `
                    <div class="mb-8">
                        ${post.featured_image ? `
                            <img src="${post.featured_image}" alt="${post.title}" class="w-full h-64 object-cover rounded-lg mb-6">
                        ` : ''}
                        <h1 class="text-3xl font-bold text-gray-800 mb-4">${post.title}</h1>
                        <div class="flex items-center text-sm text-gray-500 mb-6">
                            <div class="flex items-center space-x-2 mr-4">
                                <div class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-sm">
                                    ${(post.author_name || 'A').charAt(0).toUpperCase()}
                                </div>
                                <span>${post.author_name || 'Anonymous'}</span>
                            </div>
                            <span>${publishDate}</span>
                            <span class="mx-2">•</span>
                            <span>${Math.ceil((post.content || '').split(' ').length / 200)} min read</span>
                            <span class="mx-2">•</span>
                            <span>${post.view_count || 0} views</span>
                        </div>
                        ${post.tags && post.tags.length > 0 ? `
                            <div class="flex flex-wrap gap-2 mb-6">
                                ${post.tags.map(tag =>
                                    `<span class="px-3 py-1 bg-indigo-100 text-indigo-600 text-sm rounded-full">${tag}</span>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="blog-content prose max-w-none">
                        ${post.content.replace(/\n/g, '<br>')}
                    </div>
                `;

                document.getElementById('blog-post-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading blog post:', error);
                alert('Failed to load blog post. Please try again.');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search
            const searchInput = document.getElementById('blog-search-input');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filteredPosts = filterAndSortPosts(allBlogPosts, searchInput.value, document.getElementById('sort-filter').value);
                    displayBlogPosts(filteredPosts);
                }, 300);
            });

            // Filters
            document.getElementById('tag-filter').addEventListener('change', (e) => {
                currentPage = 1;
                loadBlogPosts(currentPage, e.target.value, searchInput.value, document.getElementById('sort-filter').value);
            });

            document.getElementById('sort-filter').addEventListener('change', (e) => {
                filteredPosts = filterAndSortPosts(allBlogPosts, searchInput.value, e.target.value);
                displayBlogPosts(filteredPosts);
            });

            // Modal
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('blog-post-modal').classList.add('hidden');
            });

            // Click outside modal to close
            document.getElementById('blog-post-modal').addEventListener('click', (e) => {
                if (e.target.id === 'blog-post-modal') {
                    document.getElementById('blog-post-modal').classList.add('hidden');
                }
            });

            // User menu
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown');

            if (userMenuButton) {
                userMenuButton.addEventListener('click', () => {
                    userDropdown.classList.toggle('hidden');
                });
            }

            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.reload();
                });
            }

            // Mobile menu (basic implementation)
            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                // TODO: Implement mobile menu toggle
                alert('Mobile menu functionality to be implemented');
            });
        }
    </script>
</body>
</html>