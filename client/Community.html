<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community | CodeMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- C·∫¨P NH·∫¨T FONT: S·ª≠ d·ª•ng Poppins cho ƒë·ªìng b·ªô -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- C·∫¨P NH·∫¨T LOGO FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%233B82F6' d='M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5'></path></svg>">
    <style>
        /* C·∫¨P NH·∫¨T FONT CHO BODY */
        body { font-family: 'Poppins', sans-serif; box-sizing: border-box; background-color: #f0f4f8; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .online-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        /* Navigation Styles */
        .nav-link { padding: 0.25rem 0.5rem; color: #4b5563; transition: color 0.2s, border-color 0.2s; border-bottom: 2px solid transparent; font-weight: 500; }
        .nav-link:hover { color: #1f2937; border-bottom-color: #6366f1; }
        .nav-link.active { color: #3b82f6; border-bottom-color: #3b82f6; font-weight: 600; }
        /* Custom Logo Style */
        .header-logo { color: #4f46e5; font-weight: 800; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-white shadow-sm border-b sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <a href="index.html" class="flex-shrink-0 flex items-center space-x-1">
                    <!-- LOGO SVG M·ªöI -->
                    <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                    <!-- LOGO TEXT ƒê·ªíNG B·ªò -->
                    <div class="text-2xl font-bold header-logo">CodeMaster</div>
                </a>
                <nav class="hidden sm:flex space-x-4 lg:space-x-8 h-full items-center">
                    <a href="CourseandLesson.html" class="nav-link">Courses</a>
                    <a href="AccountProfile.html" class="nav-link">My Learning</a>
                    <!-- ƒê√É X√ìA LI√äN K·∫æT QUIZZ -->
                    <a href="Community.html" class="nav-link active">Community</a>
                    <!-- ƒê√É X√ìA N√öT UPGRADE -->
                </nav>
            </div>
            
            <!-- KHU V·ª∞C USER/ACTION -->
            <div class="flex items-center space-x-4">
                 <!-- GI·ªÆ L·∫†I KHU V·ª∞C T√åM KI·∫æM TR√äN HEADER V√Ä ƒêI·ªÄU CH·ªàNH STYLE -->
                <div class="relative hidden sm:block">
                    <input type="text" placeholder="Search friends or groups..." class="pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                    <span class="absolute left-3 top-2.5 text-gray-400"><i class="fas fa-search"></i></span>
                </div>
                <!-- KHU V·ª∞C AVATAR & LOGOUT -->
                <div id="user-profile-btn" class="flex items-center cursor-pointer space-x-2">
                    <div id="user-avatar" class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold"></div>
                    <span id="user-name" class="text-sm font-medium hidden sm:block">Loading...</span>
                </div>
                <button id="logout-button" class="text-sm font-medium text-gray-500 hover:text-gray-800 hidden sm:block">Logout</button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid lg:grid-cols-4 gap-6">

             <!-- KHU V·ª∞C T√åM KI·∫æM D∆Ø·ªöI HEADER (ƒê√É X√ìA KHU V·ª∞C N√ÄY) -->
            
            <!-- C·ªôt tr√°i: Progress & Actions -->
            <div class="lg:col-span-1 space-y-6">
                <!-- My Progress Today -->
                <div id="progress-card" class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">My Progress Today</h3>
                    <div id="progress-data-container">
                        <div class="text-center py-6">
                            <i class="fas fa-spinner fa-spin text-indigo-500 text-3xl"></i>
                            <p class="text-sm text-gray-500 mt-2">Loading data...</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">Quick Actions</h3>
                    <div class="space-y-3">
                        <button class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            Start Study Session
                        </button>
                        <button class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                            Create Study Group
                        </button>
                        <button class="w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                            Find Study Buddy
                        </button>
                    </div>
                </div>
            </div>

            <!-- C·ªôt gi·ªØa: Leaderboard & Study Groups -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Weekly Leaderboard -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üèÜ Weekly Leaderboard</h3>
                        <select class="border rounded-lg px-3 py-1 text-sm">
                            <option>This Week</option>
                            <option>This Month</option>
                            <option>All Time</option>
                        </select>
                    </div>
                    <div id="leaderboard-container">
                        <div class="text-center py-6">
                            <i class="fas fa-spinner fa-spin text-indigo-500 text-3xl"></i>
                            <p class="text-sm text-gray-500 mt-2">Loading leaderboard...</p>
                        </div>
                    </div>
                </div>

                <!-- My Study Groups (Placeholder) -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üìö My Study Groups</h3>
                        <button class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                            Join New Group
                        </button>
                    </div>
                    <!-- Gi·ªØ nguy√™n d·ªØ li·ªáu hardcode (ch∆∞a c√≥ API Groups) -->
                     <div class="grid md:grid-cols-2 gap-4">
                        <div class="border rounded-lg p-4 card-hover">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-800">JavaScript Masters</h4>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Active</span>
                            </div>
                            <div class="flex items-center space-x-2 mb-3">
                                <div class="flex -space-x-2">
                                    <div class="w-6 h-6 bg-blue-500 rounded-full border-2 border-white"></div>
                                    <div class="w-6 h-6 bg-green-500 rounded-full border-2 border-white"></div>
                                    <div class="w-6 h-6 bg-purple-500 rounded-full border-2 border-white"></div>
                                    <div class="w-6 h-6 bg-gray-400 rounded-full border-2 border-white flex items-center justify-center text-xs text-white">+5</div>
                                </div>
                                <span class="text-sm text-gray-600">8 members</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-3">Next session: Today 7:00 PM</div>
                            <div class="flex space-x-2">
                                <button class="flex-1 bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600 transition-colors">Join Session</button>
                                <button class="px-3 py-2 border rounded text-sm hover:bg-gray-50 transition-colors">üí¨</button>
                            </div>
                        </div>

                        <div class="border rounded-lg p-4 card-hover">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-800">Data Science Squad</h4>
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Studying</span>
                            </div>
                            <div class="flex items-center space-x-2 mb-3">
                                <div class="flex -space-x-2">
                                    <div class="w-6 h-6 bg-red-500 rounded-full border-2 border-white"></div>
                                    <div class="w-6 h-6 bg-yellow-500 rounded-full border-2 border-white"></div>
                                    <div class="w-6 h-6 bg-indigo-500 rounded-full border-2 border-white"></div>
                                </div>
                                <span class="text-sm text-gray-600">6 members</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-3">Next session: Tomorrow 2:00 PM</div>
                            <div class="flex space-x-2">
                                <button class="flex-1 bg-green-500 text-white py-2 px-3 rounded text-sm hover:bg-green-600 transition-colors">View Progress</button>
                                <button class="px-3 py-2 border rounded text-sm hover:bg-gray-50 transition-colors">üí¨</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <!-- Recent Activity (Gi·ªØ nguy√™n d·ªØ li·ªáu hardcode) -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="text-xl font-bold mb-6 text-gray-800">üìà Recent Activity</h3>
                     <div class="space-y-4">
                        <div class="flex items-start space-x-3 p-3 bg-blue-50 rounded-lg">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">SM</div>
                            <div class="flex-1">
                                <div class="text-sm">
                                    <span class="font-semibold">Sarah Martinez</span> completed 
                                    <span class="font-medium text-blue-600">Advanced React Patterns</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">2 hours ago ‚Ä¢ +150 points</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-green-50 rounded-lg">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">DK</div>
                            <div class="flex-1">
                                <div class="text-sm">
                                    <span class="font-semibold">David Kim</span> started a new study streak! 
                                    <span class="font-medium text-green-600">7 days in a row</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">4 hours ago ‚Ä¢ +200 bonus points</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- C·ªôt ph·∫£i: Friends Online & Challenges -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Friends Online -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">üë• Friends Online</h3>
                        <span id="friends-online-count" class="text-sm text-gray-500">Loading...</span>
                    </div>
                    <div id="friends-online-container" class="space-y-3">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin text-indigo-500"></i>
                        </div>
                    </div>
                    <button class="w-full mt-4 text-blue-500 hover:text-blue-600 text-sm font-medium">
                        View All Friends
                    </button>
                </div>

                <!-- Active Challenges (Gi·ªØ nguy√™n d·ªØ li·ªáu hardcode) -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">üéØ Active Challenges</h3>
                     <div class="space-y-4">
                        <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-semibold text-blue-800">7-Day Streak</h4>
                                <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full">5/7 days</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2 mb-2">
                                <div class="bg-blue-500 h-2 rounded-full progress-bar" style="width: 71%"></div>
                            </div>
                            <div class="text-xs text-blue-700">Study for 7 consecutive days</div>
                        </div>
                    </div>
                    <button class="w-full mt-4 text-blue-500 hover:text-blue-600 text-sm font-medium">
                        See More Suggestions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- AUTH & SETUP ---
        const API_BASE = '/api/community'; 
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        
        if (!token || !user) {
            window.location.href = 'LoginPage.html';
            // Fallback for demo, but typically this should redirect
        }

        function getUserInitials() {
            if (user && user.name) {
                const parts = user.name.split(' ');
                let initials = parts[0].charAt(0).toUpperCase();
                if (parts.length > 1) {
                    initials += parts.pop().charAt(0).toUpperCase();
                }
                return initials;
            }
            return 'AC';
        }

        // --- RENDER FUNCTIONS ---

        // Render My Progress Today (API: /progress)
        async function renderUserProgress() {
            const container = document.getElementById('progress-data-container');
            try {
                const response = await fetch(`${API_BASE}/progress`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Failed to fetch progress.');
                const data = await response.json();

                const studyTimePercent = (data.studyTime.current / data.studyTime.goal) * 100;
                const coursesPercent = (data.coursesCompleted.current / data.coursesCompleted.goal) * 100;
                const weeklyPercent = (data.weeklyGoal.current / data.weeklyGoal.goal) * 100;
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Study Time</span>
                                <span class="font-semibold">${data.studyTime.current.toFixed(1)}${data.studyTime.unit} / ${data.studyTime.goal}${data.studyTime.unit}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full progress-bar" style="width: ${studyTimePercent}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Courses Completed</span>
                                <span class="font-semibold">${data.coursesCompleted.current} / ${data.coursesCompleted.goal}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full progress-bar" style="width: ${coursesPercent}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Weekly Goal</span>
                                <span class="font-semibold">${data.weeklyGoal.current}${data.weeklyGoal.unit} / ${data.weeklyGoal.goal}${data.weeklyGoal.unit}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full progress-bar" style="width: ${weeklyPercent}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${data.studyPoints.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">Study Points</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("Progress fetch error:", error);
                container.innerHTML = `<p class="text-sm text-red-500">Error loading progress.</p>`;
            }
        }

        // Render Leaderboard (API: /leaderboard)
        async function renderLeaderboard() {
            const container = document.getElementById('leaderboard-container');
            try {
                const response = await fetch(`${API_BASE}/leaderboard`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Failed to fetch leaderboard.');
                const leaderboard = await response.json();

                container.innerHTML = leaderboard.map(entry => {
                    const isCurrentUser = entry.name.includes(user.name || "Alex Chen");
                    const bgColor = isCurrentUser ? 'bg-orange-50 border border-orange-300' : 'bg-gray-50';
                    const rankEmoji = entry.rank === 1 ? 'ü•á' : entry.rank === 2 ? 'ü•à' : entry.rank === 3 ? 'ü•â' : entry.rank;
                    const rankColor = entry.rank <= 3 ? 'text-2xl' : 'text-lg text-gray-400';
                    const pointColor = entry.change > 0 ? 'text-green-600' : 'text-gray-500';

                    return `
                        <div class="flex items-center justify-between p-3 ${bgColor} rounded-lg card-hover">
                            <div class="flex items-center space-x-3">
                                <div class="${rankColor}">${rankEmoji}</div>
                                <div class="w-10 h-10 bg-${entry.color} rounded-full flex items-center justify-center text-white font-bold">
                                    ${entry.initials}
                                </div>
                                <div>
                                    <div class="font-semibold">${entry.name} ${isCurrentUser ? '(You)' : ''}</div>
                                    <div class="text-sm text-gray-600">${entry.hours} hours studied</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-orange-600">${entry.points.toLocaleString()} pts</div>
                                <div class="text-xs ${pointColor}">+${entry.change} this week</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Leaderboard fetch error:", error);
                container.innerHTML = `<p class="text-sm text-red-500">Error loading leaderboard.</p>`;
            }
        }

        // Render Friends Online (API: /friends)
        async function renderFriendsStatus() {
            const container = document.getElementById('friends-online-container');
            const countElement = document.getElementById('friends-online-count');
            try {
                const response = await fetch(`${API_BASE}/friends`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Failed to fetch friends status.');
                const data = await response.json();

                countElement.textContent = `${data.totalOnline} online`;

                container.innerHTML = data.friends.map(friend => {
                    const onlineIndicator = friend.online 
                        ? `<div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white online-indicator"></div>`
                        : `<div class="absolute -bottom-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border-2 border-white"></div>`;

                    return `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <div class="w-8 h-8 bg-${friend.color} rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                        ${friend.initials}
                                    </div>
                                    ${onlineIndicator}
                                </div>
                                <div>
                                    <div class="text-sm font-semibold">${friend.name}</div>
                                    <div class="text-xs text-gray-500">${friend.status}</div>
                                </div>
                            </div>
                            <button class="text-blue-500 hover:text-blue-600 text-lg">
                                ${friend.emoji}
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Friends status error:", error);
                container.innerHTML = `<p class="text-sm text-red-500">Error loading friends list.</p>`;
                countElement.textContent = `0 online`;
            }
        }

        // --- INITIALIZATION ---
        function setupListeners() {
            // Update user info in header
            const initials = getUserInitials();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = user.name;
            
            // Logout functionality
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = 'LoginPage.html';
            });

            // Redirect user profile click (Header avatar)
            document.getElementById('user-profile-btn').addEventListener('click', () => {
                window.location.href = 'ProfilePage.html';
            });
            
            // Add click handlers for all hardcoded buttons (simulations)
            document.querySelectorAll('.quick-action-btn, .group-action-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    alert(`Action triggered: ${e.currentTarget.textContent.trim()}`);
                    // In a real app, this would trigger an API call to start session/create group/etc.
                });
            });
        }
        
        setupListeners();
        renderUserProgress();
        renderLeaderboard();
        renderFriendsStatus();

    </script>
</body>
</html>
